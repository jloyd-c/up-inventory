{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/department.css' %}">

<!-- Edit Department Modal -->
<div id="editModal" class="modal">
  <div class="card form-card modal-content">
    <button class="modal-close-btn" onclick="closeModal()" aria-label="Close modal">&times;</button>
    <div class="card-header">EDIT DEPARTMENT</div>
    <form id="editDepartmentForm" method="post" class="staff-form">
      {% csrf_token %}
      <input type="hidden" name="id" id="edit-id" />
      <p>
        <label for="edit-name">Department Name:</label>
        <input type="text" name="name" id="edit-name" required>
      </p>
      <div class="modal-buttons">
        <button type="submit" class="btn btn-update">Update Department</button>
        <button type="button" class="btn cancel-btn" onclick="closeModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="staff-container">

  {% if user.is_superuser %}
  <!-- Add Department Form Card -->
  <div class="card form-card">
    <div class="card-header">ADD NEW DEPARTMENT</div>
    <form action="{% url 'add_department' %}" method="post" class="staff-form">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn submit-btn">Add Department</button>
    </form>
  </div>
  {% endif %}

  <!-- Department Table Card -->
  <div class="card table-card">
    <div class="card-header">DEPARTMENT LIST</div>

    <div class="search-download-wrapper">
      <form method="get" action="" class="search-form">
        <input
          type="text"
          id="search"
          name="q"
          placeholder="Search departments..."
          value="{{ query }}"
          class="search-input"
        />
      </form>

      <a href="{% url 'export_department_excel' %}" class="btn btn-download">
        Download Excel
      </a>
    </div>

    <table class="staff-table">
      <thead>
        <tr>
          <th>Department Name</th>
          <th>Date Created</th>
          {% if user.is_superuser %}
          <th>Actions</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for dept in departments %}
        <tr>
          <td>{{ dept.name }}</td>
          <td>{{ dept.created_at|date:"Y-m-d H:i" }}</td>
          {% if user.is_superuser %}
          <td class="action-style">
            <a href="javascript:void(0);" 
               class="btn edit-btn"
               data-id="{{ dept.id }}"
               data-name="{{ dept.name|escapejs }}"
               onclick="handleEditClick(this)">
               Edit
            </a>

            <form action="{% url 'delete_department' dept.pk %}" method="post" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger delete-btn" onclick="return confirm('Delete this department?')">Delete</button>
            </form>
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="3">No departments found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  function handleEditClick(element) {
    document.getElementById('edit-id').value = element.dataset.id;
    document.getElementById('edit-name').value = element.dataset.name;
    document.getElementById('editModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('editModal').style.display = 'none';
  }

  document.getElementById('search').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('.staff-table tbody tr');

    rows.forEach(row => {
      const deptName = row.cells[0].textContent.toLowerCase();
      if (deptName.includes(filter)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
</script>
{% endblock %}
