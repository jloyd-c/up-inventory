{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Font Awesome and Bootstrap CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/staff.css' %}">

<div class="staff-page container mt-4">
  <!-- Top Bar -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="fas fa-boxes me-2"></i>Inventory Management</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" onclick="document.getElementById('borrowModal').style.display='flex'">
        <i class="fas fa-plus me-1"></i>Borrow Device
      </button>
      <button class="btn btn-primary" onclick="document.getElementById('returnModal').style.display='flex'">
        <i class="fas fa-undo me-1"></i>Return Device
      </button>
      <a href="{% url 'export_inventory_excel' %}?date={{ filter_date|urlencode }}" class="btn-download">
        <i class="fas fa-file-excel me-1"></i>Download Excel
      </a>
    </div>
  </div>

  <!-- Search & Filter Bar -->
<div class="row mb-3">
  <div class="col-md-6">
    <form method="GET" action="{% url 'inventory' %}" id="searchForm">
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Search inventory..." name="q" value="{{ request.GET.q }}" id="searchInput">
        <button class="btn btn-primary" type="submit">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </form>
  </div>
  <div class="col-md-6 text-end">
    <div class="dropdown">
      <button class="btn btn-filter dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-filter me-1"></i>Filter
      </button>
      <div class="dropdown-menu dropdown-menu-end filter-dropdown p-3" aria-labelledby="filterDropdown">
        <form method="GET" action="{% url 'inventory' %}" id="filterForm">
          <input type="hidden" name="q" value="{{ request.GET.q }}">
          
          <div class="filter-section mb-3">
            <label class="filter-label">Staff Name</label>
            <select class="form-select filter-select" name="staff_name" id="staffNameFilter">
              <option value="">All Staff</option>
              {% for staff in all_staff %}
              <option value="{{ staff.id }}" {% if request.GET.staff_name == staff.id|stringformat:"s" %}selected{% endif %}>
                {{ staff.full_name }}
              </option>
              {% endfor %}
            </select>
          </div>
          
          <div class="filter-section mb-3">
            <label class="filter-label">Date</label>
            <input type="date" class="form-control date-input" name="date" id="filterDate" value="{{ filter_date }}">
          </div>
          
          <div class="filter-section mb-3">
            <label class="filter-label">Status</label>
            <select class="form-select filter-select" name="status" id="statusFilter">
              <option value="">All Statuses</option>
              <option value="borrowed" {% if request.GET.status == 'borrowed' %}selected{% endif %}>Borrowed Only</option>
              <option value="returned" {% if request.GET.status == 'returned' %}selected{% endif %}>Returned Only</option>
            </select>
          </div>
          
          <div class="d-flex justify-content-between mt-3">
            <button type="button" class="btn btn-secondary" onclick="resetFilters()">Reset</button>
            <button type="submit" class="btn btn-primary">Apply</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

  <!-- Borrowed Devices Section -->
  <div class="mb-4">
    <h4 class="mb-3"><i class="fas fa-laptop me-2"></i>Borrowed Devices</h4>
    <div class="card shadow rounded-4">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle text-center" id="borrowedTable">
            <thead class="table-light">
              <tr>
                <th>Staff Name</th>
                <th>Department</th>
                <th>Equipment</th>
                <th>Model/Brand</th>
                <th>Date Issued</th>
                <th>Serial Number</th>
                <th>PR Number</th>
                <th>Remarks</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for record in borrowed_records %}
              <tr>
                <td>{{ record.staff.full_name }}</td>
                <td>{{ record.staff.department.name }}</td>
                <td>{{ record.device.name }}</td>
                <td>{{ record.device.model_brand }}</td>
                <td>{{ record.date_issued|date:"Y-m-d H:i" }}</td>
                <td>{{ record.device.serial_number }}</td>
                <td>{{ record.pr_number }}</td>
                <td>{{ record.remarks }}</td>
                <td class="action-style text-center">
                  <button class="btn btn-action btn-edit" onclick="openEditBorrowModal('{{ record.id }}')">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="9">No borrowed devices.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Returned Devices Section -->
  <div>
    <h4 class="mb-3"><i class="fas fa-check-circle me-2"></i>Returned Devices</h4>
    <div class="card shadow rounded-4">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle text-center" id="returnedTable">
            <thead class="table-light">
              <tr>
                <th>Staff Name</th>
                <th>Department</th>
                <th>Equipment</th>
                <th>Model/Brand</th>
                <th>Date Issued</th>
                <th>Date Returned</th>
                <th>Serial Number</th>
                <th>PR Number</th>
                <th>Remarks</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for record in returned_records %}
              <tr>
                <td>{{ record.staff.full_name }}</td>
                <td>{{ record.staff.department.name }}</td>
                <td>{{ record.device.name }}</td>
                <td>{{ record.device.model_brand }}</td>
                <td>{{ record.date_issued|date:"Y-m-d H:i" }}</td>
                <td>{{ record.date_returned|date:"Y-m-d H:i" }}</td>
                <td>{{ record.device.serial_number }}</td>
                <td>{{ record.pr_number }}</td>
                <td>{{ record.remarks }}</td>
                <td class="action-style text-center">
                  <button class="btn btn-action btn-edit" onclick="openEditReturnModal('{{ record.id }}')">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="btn btn-action btn-delete" onclick="openDeleteReturnModal('{{ record.id }}')">
                    <i class="fas fa-trash-alt"></i> Delete
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="10">No returned devices.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Borrow Modal -->
<div id="borrowModal" class="modal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Borrow Device</h5>
        <button type="button" class="btn-close" onclick="closeModal('borrowModal')"></button>
      </div>
      <form method="post" class="staff-form">
        {% csrf_token %}
        <input type="hidden" name="borrow_submit" value="1">
        <div class="modal-body">
          <div class="mb-3">
            <label for="staff_select">Staff</label>
            <select name="staff" id="staff_select" class="form-select" onchange="fillStaffInfo()" required>
              <option value="">Select staff</option>
              {% for staff in active_staff %}
              <option value="{{ staff.id }}" data-name="{{ staff.full_name }}" data-department="{{ staff.department.name }}">
                {{ staff.full_name }} ({{ staff.department.name }})
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label>Name of Staff</label>
            <input type="text" id="staff_name" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Department</label>
            <input type="text" id="staff_department" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label for="device_select">Device</label>
            <select name="device" id="device_select" class="form-select" onchange="fillDeviceInfo()" required>
              <option value="">Select device</option>
              {% for device in available_devices %}
              <option value="{{ device.id }}" data-name="{{ device.name }}" data-model="{{ device.model_brand }}" data-serial="{{ device.serial_number }}">
                {{ device.name }} - {{ device.model_brand }} ({{ device.serial_number }})
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label>Equipment</label>
            <input type="text" id="device_name" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Model/Brand</label>
            <input type="text" id="device_model" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Serial Number</label>
            <input type="text" id="device_serial" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>PR Number</label>
            <input type="text" name="pr_number" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Remarks</label>
            <textarea name="remarks" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Confirm Borrow</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('borrowModal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Return Modal -->
<div id="returnModal" class="modal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Return Device</h5>
        <button type="button" class="btn-close" onclick="closeModal('returnModal')"></button>
      </div>
      <form method="post" class="staff-form">
        {% csrf_token %}
        <input type="hidden" name="return_submit" value="1">
        <div class="modal-body">
          <div class="mb-3">
            <label>Borrow Record</label>
            <select name="borrow_record" class="form-select" required>
              {% for record in borrowed_records %}
              <option value="{{ record.id }}">{{ record.staff.full_name }} - {{ record.device.name }} ({{ record.device.serial_number }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label>Remarks</label>
            <textarea name="return_remarks" class="form-control"></textarea>
          </div>
          <div class="mb-3">
            <label>Device Condition</label>
            <select name="device_status" class="form-select">
              <option value="available">Available</option>
              <option value="damaged">Damaged</option>
              <option value="maintenance">Maintenance</option>
              <option value="lost">Lost</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Confirm Return</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('returnModal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Borrow Modal -->
<div class="modal" id="editBorrowModal" tabindex="-1" style="display:none;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Edit Borrow Record</h5>
        <button type="button" class="btn-close" onclick="closeEditBorrowModal()"></button>
      </div>
      <form method="post" action="" id="editBorrowForm">
        {% csrf_token %}
        <input type="hidden" name="id" id="edit-borrow-id" />
        <div class="modal-body">
          <div class="mb-3">
            <label>Staff Name</label>
            <input type="text" name="staff_name" id="edit-borrow-staff-name" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Department</label>
            <input type="text" name="department" id="edit-borrow-department" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Equipment</label>
            <input type="text" name="device_name" id="edit-borrow-device-name" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Model/Brand</label>
            <input type="text" name="device_model" id="edit-borrow-device-model" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Serial Number</label>
            <input type="text" name="serial_number" id="edit-borrow-serial-number" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>PR Number</label>
            <input type="text" name="pr_number" id="edit-borrow-pr-number" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Remarks</label>
            <textarea name="remarks" id="edit-borrow-remarks" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Update Record</button>
          <button class="btn btn-secondary" type="button" onclick="closeEditBorrowModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Return Modal -->
<div class="modal" id="editReturnModal" tabindex="-1" style="display:none;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Edit Return Record</h5>
        <button type="button" class="btn-close" onclick="closeEditReturnModal()"></button>
      </div>
      <form method="post" action="" id="editReturnForm">
        {% csrf_token %}
        <input type="hidden" name="id" id="edit-return-id" />
        <div class="modal-body">
          <div class="mb-3">
            <label>Staff Name</label>
            <input type="text" name="staff_name" id="edit-return-staff-name" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Department</label>
            <input type="text" name="department" id="edit-return-department" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Equipment</label>
            <input type="text" name="device_name" id="edit-return-device-name" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Model/Brand</label>
            <input type="text" name="device_model" id="edit-return-device-model" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Serial Number</label>
            <input type="text" name="serial_number" id="edit-return-serial-number" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Date Issued</label>
            <input type="text" name="date_issued" id="edit-return-date-issued" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label>Date Returned</label>
            <input type="datetime-local" name="date_returned" id="edit-return-date-returned" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>PR Number</label>
            <input type="text" name="pr_number" id="edit-return-pr-number" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Remarks</label>
            <textarea name="remarks" id="edit-return-remarks" class="form-control"></textarea>
          </div>
          <div class="mb-3">
            <label>Device Condition</label>
            <select name="device_status" id="edit-return-device-status" class="form-select">
              <option value="available">Available</option>
              <option value="damaged">Damaged</option>
              <option value="maintenance">Maintenance</option>
              <option value="lost">Lost</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Update Record</button>
          <button class="btn btn-secondary" type="button" onclick="closeEditReturnModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Return Confirmation Modal -->
<div class="modal" id="deleteReturnModal" tabindex="-1" style="display:none;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" onclick="closeDeleteReturnModal()"></button>
      </div>
      <form method="post" id="deleteReturnForm">
        {% csrf_token %}
        <div class="modal-body">
          <p>Are you sure you want to delete this return record?</p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Delete</button>
          <button type="button" class="btn btn-secondary" onclick="closeDeleteReturnModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
function closeModal(id) {
  document.getElementById(id).style.display = "none";
}

function fillStaffInfo() {
  const select = document.getElementById("staff_select");
  const name = select.options[select.selectedIndex]?.getAttribute("data-name") || "";
  const department = select.options[select.selectedIndex]?.getAttribute("data-department") || "";
  document.getElementById("staff_name").value = name;
  document.getElementById("staff_department").value = department;
}

function fillDeviceInfo() {
  const select = document.getElementById("device_select");
  const name = select.options[select.selectedIndex]?.getAttribute("data-name") || "";
  const model = select.options[select.selectedIndex]?.getAttribute("data-model") || "";
  const serial = select.options[select.selectedIndex]?.getAttribute("data-serial") || "";
  document.getElementById("device_name").value = name;
  document.getElementById("device_model").value = model;
  document.getElementById("device_serial").value = serial;
}

function openEditBorrowModal(recordId) {
  document.getElementById("edit-borrow-id").value = recordId;
  document.getElementById("editBorrowModal").style.display = "flex";
}

function closeEditBorrowModal() {
  document.getElementById("editBorrowModal").style.display = "none";
}

function openEditReturnModal(recordId) {
  document.getElementById("edit-return-id").value = recordId;
  document.getElementById("editReturnModal").style.display = "flex";
}

function closeEditReturnModal() {
  document.getElementById("editReturnModal").style.display = "none";
}

function openDeleteReturnModal(recordId) {
  const deleteForm = document.getElementById('deleteReturnForm');
  const baseUrl = "{% url 'return_delete' 0 %}".slice(0, -2);
  deleteForm.action = `${baseUrl}${recordId}/`;
  document.getElementById('deleteReturnModal').style.display = 'flex';
}

function closeDeleteReturnModal() {
  document.getElementById('deleteReturnModal').style.display = 'none';
}

function resetFilters() {
  document.getElementById('staffNameFilter').value = '';
  document.getElementById('filterDate').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('filterForm').submit();
}

// Client-side search for both tables
document.getElementById('searchInput')?.addEventListener('input', function() {
  const filter = this.value.toLowerCase();
  
  // Search borrowed table
  const borrowedRows = document.querySelectorAll('#borrowedTable tbody tr');
  borrowedRows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(filter) ? '' : 'none';
  });
  
  // Search returned table
  const returnedRows = document.querySelectorAll('#returnedTable tbody tr');
  returnedRows.forEach(row => {
    const rowText = row.textContent.toLowerCase();
    row.style.display = rowText.includes(filter) ? '' : 'none';
  });
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}