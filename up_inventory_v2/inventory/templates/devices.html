{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Font Awesome and Bootstrap CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/devices.css' %}"> <!-- same style as staff -->

<div class="staff-page container mt-4">
  <!-- Top Bar -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="fas fa-desktop me-2"></i>Device Management</h2>
    <div class="d-flex gap-2">
      {% if user.is_superuser %}
      <button class="btn btn-primary" onclick="openAddModal()">
        <i class="fas fa-plus me-1"></i>Add Device
      </button>
      <a href="{% url 'export_device_excel' %}" class="btn-download">
        <i class="fas fa-file-excel me-1"></i>Download Excel
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Filter & Search Bar -->
  <div class="row mb-3">
    <div class="col-md-6">
      <input type="text" class="form-control" placeholder="Search devices..." id="searchInput">
    </div>
    <div class="col-md-6 text-end">
      <button class="btn btn-filter">
        <i class="fas fa-filter me-1"></i>Filter
      </button>
    </div>
  </div>

  <!-- Device Table -->
  <div class="card shadow rounded-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-striped align-middle text-center" id="deviceTable">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Model/Brand</th>
              <th>Serial Number</th>
              <th>Status</th>
              <th>Date Added</th>
              {% if user.is_superuser %}<th>Actions</th>{% endif %}
            </tr>
          </thead>
          <tbody>
            {% for device in devices %}
            <tr>
              <td>{{ device.name }}</td>
              <td>{{ device.model_brand }}</td>
              <td>{{ device.serial_number }}</td>
              <td>{{ device.get_status_display }}</td>
              <td>{{ device.created_at|date:"Y-m-d" }}</td>
              {% if user.is_superuser %}
              <td class="action-style">
                <button class="edit-btn"
                        onclick="handleEditClick(this)"
                        data-id="{{ device.id }}"
                        data-name="{{ device.name|escapejs }}"
                        data-model-brand="{{ device.model_brand|escapejs }}"
                        data-serial-number="{{ device.serial_number|escapejs }}"
                        data-status="{{ device.status|escapejs }}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="openDeleteModal('{{ device.pk }}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
              {% endif %}
            </tr>
            {% empty %}
            <tr><td colspan="6">No devices found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add Device Modal -->
<div class="modal" id="addModal" tabindex="-1" style="display:none;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Add New Device</h5>
        <button type="button" class="btn-close" onclick="closeAddModal()"></button>
      </div>
      <form method="post" action="{% url 'add_device' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label>Name</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Model/Brand</label>
            <input type="text" name="model_brand" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Serial Number</label>
            <input type="text" name="serial_number" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Status</label>
            <select name="status" class="form-select" required>
              {% for value, label in form.fields.status.choices %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Add Device</button>
          <button class="btn btn-secondary" type="button" onclick="closeAddModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Device Modal -->
<div class="modal" id="editModal" tabindex="-1" style="display:none;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Edit Device</h5>
        <button type="button" class="btn-close" onclick="closeEditModal()"></button>
      </div>
      <form method="post" action="" id="editDeviceForm">
        {% csrf_token %}
        <input type="hidden" name="id" id="edit-id">
        <div class="modal-body">
          <div class="mb-3">
            <label>Name</label>
            <input type="text" name="name" id="edit-name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Model/Brand</label>
            <input type="text" name="model_brand" id="edit-model-brand" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Serial Number</label>
            <input type="text" name="serial_number" id="edit-serial-number" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Status</label>
            <select name="status" id="edit-status" class="form-select" required>
              {% for value, label in form.fields.status.choices %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Update Device</button>
          <button class="btn btn-secondary" type="button" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal" tabindex="-1" style="display:none;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" onclick="closeDeleteModal()"></button>
      </div>
      <form method="post" id="deleteForm">
        {% csrf_token %}
        <div class="modal-body">
          <p>Are you sure you want to delete this device?</p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Delete</button>
          <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  function openAddModal() { document.getElementById("addModal").style.display = "block"; }
  function closeAddModal() { document.getElementById("addModal").style.display = "none"; }
  function closeEditModal() { document.getElementById("editModal").style.display = "none"; }

  function handleEditClick(btn) {
    const id = btn.dataset.id;
    document.getElementById("edit-id").value = id;
    document.getElementById("edit-name").value = btn.dataset.name;
    document.getElementById("edit-model-brand").value = btn.dataset.modelBrand;
    document.getElementById("edit-serial-number").value = btn.dataset.serialNumber;
    document.getElementById("edit-status").value = btn.dataset.status;
    document.getElementById("editDeviceForm").action = `/devices/update/${id}/`;
    document.getElementById("editModal").style.display = "block";
  }

  document.getElementById('searchInput').addEventListener('input', function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#deviceTable tbody tr');
    rows.forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
  });

  function openDeleteModal(id) {
    const form = document.getElementById('deleteForm');
    const baseUrl = "{% url 'delete_device' 0 %}".slice(0, -2);
    form.action = `${baseUrl}${id}/`;
    document.getElementById('deleteModal').style.display = 'flex';
  }
  function closeDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; }
</script>

{% endblock %}
